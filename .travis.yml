language: python

services:
    - docker

before_install:
    - docker --version
    - docker-compose --version
    - cp settings/{__,}local_settings.py
    - cp settings/{env_file,.env}
    - echo "GUNICORN_CMD_ARGS=--workers=3" >> settings/.env
    - docker-compose build
    - docker-compose up -d
    - docker ps -a

script:
    - docker-compose exec web bash wait-for-mysql.sh
    - docker-compose exec web coverage run manage.py test

after_success:
    - docker-compose exec web bash <(curl -s https://codecov.io/bash) 

after_failure:
    - docker-compose logs
